<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#fafafa">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root {
  --bg:#fafafa; --text:#222; --muted:#777; --border:#e5e5e5;
}
body.dark {
  --bg:#121212; --text:#eaeaea; --muted:#aaa; --border:#333;
}
body {
  font-family:"Georgia","Times New Roman",serif;
  background:var(--bg); color:var(--text);
  max-width:720px; margin:auto; padding:32px 24px;
  line-height:1.8; letter-spacing:.01em; font-size:1rem;
}
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
h1 { font-size:1.3rem; font-weight:500; letter-spacing:.02em; }
button, select {
  background:none; border:none; color:var(--muted);
  font-size:.85rem; cursor:pointer; padding:4px;
}
button:hover { color:var(--text); }
textarea {
  width:100%; min-height:120px; padding:16px;
  border:none; border-bottom:1px solid var(--border);
  background:var(--bg); color:var(--text);
  font-family:inherit; font-size:1rem;
}
textarea:focus { outline:none; }
textarea[readonly]{background:var(--bg); border-bottom:1px dashed var(--border); color:var(--muted);}
.day {
  margin-top:36px; padding:16px 12px; border-left:3px solid var(--border); border-radius:6px;
  background:rgba(0,0,0,.01);
}
.date { font-size:.85rem; color:var(--muted); margin-bottom:10px; font-weight:500; }
.today { color:var(--text); font-weight:600; }
.entry { margin-bottom:16px; font-size:1rem; }
.time { font-size:.75rem; color:var(--muted); margin-bottom:2px; }
.on-this-day {
  margin-top:28px; padding:14px;
  border:1px dashed var(--border); border-radius:6px;
  font-size:.88rem; font-style:italic;
}
#drawer { display:none; margin-top:12px; border-top:1px solid var(--border); padding-top:12px; }
#drawer button, #drawer select { display:block; margin:6px 0; color:var(--text); }
#cheat { position:fixed;top:8px;left:50%;transform:translateX(-50%);
background:var(--bg);color:var(--muted);padding:6px 12px;border:1px solid var(--border);
border-radius:6px;font-size:.8rem;opacity:.9;z-index:9999;display:none;}
</style>
</head>

<body>

<!-- Cheat Sheet Overlay -->
<div id="cheat">Ctrl/Cmd+Enter to save • ⋯ for tools • Reflection to browse</div>

<header>
  <h1>Journal</h1>
  <div>
    <button onclick="toggleDrawer()">⋯</button>
    <button onclick="toggleMode()" id="modeBtn">Reflection</button>
  </div>
</header>

<textarea id="input" placeholder="Write…"></textarea>

<div id="drawer">
  <button onclick="toggleDark()">Toggle dark mode</button>
  <select id="yearFilter" onchange="applyYearFilter()"><option value="all">All years</option></select>
  <button onclick="exportTxt()">Export TXT</button>
  <button onclick="exportMd()">Export Markdown</button>
  <button onclick="backup()">Backup</button>
  <button onclick="restore()">Restore</button>
</div>

<input type="file" id="restoreFile" hidden>
<div id="journal"></div>

<script>
/* DRAWER */
function toggleDrawer(){drawer.style.display = drawer.style.display==="block" ? "none" : "block";}

/* DARK MODE */
if(localStorage.getItem("dark")==="true") document.body.classList.add("dark");
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
}

/* REFLECTION MODE */
let reflection=false;
function toggleMode(){
  reflection=!reflection;
  modeBtn.textContent=reflection?"Write":"Reflection";
  input.readOnly=reflection;
  input.style.display=reflection?"none":"block";
}

/* CORE */
const input=document.getElementById("input");
const journalDiv=document.getElementById("journal");
input.focus();
document.addEventListener("keydown",e=>{
  if(!reflection&&(e.ctrlKey||e.metaKey)&&e.key==="Enter") addEntry();
});
function todayKey(d=new Date()){return d.toISOString().split("T")[0];}

function addEntry(){
  const text=input.value.trim(); if(!text) return;
  const now=new Date(), key=todayKey();
  const data=JSON.parse(localStorage.getItem("journal")||"{}");
  data[key]=data[key]||[];
  data[key].unshift({time:now.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),text});
  localStorage.setItem("journal",JSON.stringify(data));
  populateYearFilter(); load();
  input.value=""; input.focus();
}

function load(year="all"){
  journalDiv.innerHTML="";
  const data=JSON.parse(localStorage.getItem("journal")||"{}");
  Object.keys(data).sort().reverse().forEach(date=>{
    if(year==="all"||date.startsWith(year)) renderDay(date,data[date]);
  });
  showOnThisDay();
}

function renderDay(date,entries){
  const d=new Date(date);
  const div=document.createElement("div"); div.className="day";
  div.innerHTML=`<div class="date ${date===todayKey()?"today":""}">
    ${date===todayKey()?"Today — ":""}${d.toDateString()}</div>`;
  entries.forEach(e=>{div.innerHTML+=`<div class="entry">
    <div class="time">${e.time}</div>${e.text}</div>`;});
  journalDiv.appendChild(div);
}

/* YEAR FILTER */
function populateYearFilter(){
  const data=JSON.parse(localStorage.getItem("journal")||"{}");
  const years=[...new Set(Object.keys(data).map(d=>d.slice(0,4)))].sort().reverse();
  yearFilter.innerHTML='<option value="all">All years</option>';
  years.forEach(y=>yearFilter.innerHTML+=`<option>${y}</option>`);
}
function applyYearFilter(){ load(yearFilter.value); }

/* ON THIS DAY */
function showOnThisDay(){
  const data=JSON.parse(localStorage.getItem("journal")||"{}");
  const mmdd=todayKey().slice(5);
  const hits=Object.keys(data).filter(d=>d.endsWith(mmdd)&&!d.startsWith(new Date().getFullYear()));
  if(!hits.length) return;
  const box=document.createElement("div");
  box.className="on-this-day"; box.textContent="On this day:";
  hits.sort().reverse().forEach(d=>{
    data[d].forEach(e=>box.innerHTML+=`<div>${d.slice(0,4)} — ${e.text}</div>`);
  });
  journalDiv.prepend(box);
}

/* EXPORT / BACKUP */
function exportTxt(){ download(format("txt"),"journal.txt"); }
function exportMd(){ download(format("md"),"journal.md"); }
function format(type){
  const data=JSON.parse(localStorage.getItem("journal")||"{}"); let out="";
  Object.keys(data).sort().forEach(d=>{
    data[d].forEach(e=>{out+=type==="md"?`## ${d}\n- **${e.time}** ${e.text}\n\n`:`${d} ${e.time} - ${e.text}\n`;});
  }); return out;
}
function download(c,n){const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([c])); a.download=n; a.click();}
function backup(){ download(localStorage.getItem("journal")||"{}","journal-backup.json"); }
function restore(){ restoreFile.click(); }
restoreFile.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{ localStorage.setItem("journal",ev.target.result); populateYearFilter(); load(); };
  r.readAsText(e.target.files[0]);
};

/* CHEAT SHEET OVERLAY */
if(!localStorage.getItem("seenCheat")){
  const cheat=document.getElementById("cheat");
  cheat.style.display="block";
  setTimeout(()=>{cheat.style.display="none"; localStorage.setItem("seenCheat","true");},5000);
}

/* SERVICE WORKER REGISTRATION */
if("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");

populateYearFilter(); load();
</script>
</body>
</html>
