<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiet Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fafafa">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { --bg:#fafafa; --text:#222; --muted:#777; --border:#e5e5e5; }
    body.dark { --bg:#121212; --text:#eaeaea; --muted:#aaa; --border:#333; }
    body { font-family:"Georgia","Times New Roman",serif; background:var(--bg); color:var(--text);
    max-width:720px; margin:auto; padding:16px 12px; line-height:1.5; letter-spacing:.005em; font-size:.9rem; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    h1 { font-size:1.1rem; font-weight:500; letter-spacing:.02em; }
    button, select { background:none; border:none; color:var(--muted); font-size:.75rem; cursor:pointer; padding:2px 4px; }
    button:hover { color:var(--text); }
    textarea { width:100%; min-height:80px; padding:10px; border:none; border-bottom:1px solid var(--border);
    background:var(--bg); color:var(--text); font-family:inherit; font-size:.9rem; line-height:1.4; resize:none; overflow-y:hidden; }
    textarea:focus { outline:none; }
    textarea[readonly]{background:var(--bg); border-bottom:1px dashed var(--border); color:var(--muted);}
    .day { margin-top:24px; padding:8px 10px; border-left:2px solid var(--border); border-radius:4px;
    background:rgba(0,0,0,.01);}
    .date { font-size:.75rem; color:var(--muted); margin-bottom:6px; font-weight:500; }
    .today { color:var(--text); font-weight:600; }

    /* COMPACT & ALIGNED ENTRIES */
    .entry {
      margin-bottom:8px;
      font-size:.88rem;
      display:grid;
      grid-template-columns: auto 1fr auto; /* time | text | buttons */
      grid-column-gap:6px;
      align-items:start;
    }
    .time {
      font-size:.7rem;
      color:var(--muted);
      white-space:nowrap;
    }
    .entry .text {
      word-break:break-word;
      white-space: pre-wrap;
    }
    .entry .buttons { 
      display:flex; 
      gap:4px;
    }
    .entry button {
      font-size:.65rem;
      margin-left:0;
      padding:1px 3px;
      color:var(--muted);
    }
    .entry button:hover { color:var(--text); }

    .on-this-day { margin-top:16px; padding:8px 10px; border:1px dashed var(--border); border-radius:4px;
    font-size:.78rem; font-style:italic; }
    #drawer { display:none; margin-top:8px; border-top:1px solid var(--border); padding-top:8px; }
    #drawer button, #drawer select { display:block; margin:4px 0; color:var(--text); font-size:.75rem; }
    #cheat { position:fixed;top:4px;left:50%;transform:translateX(-50%);
    background:var(--bg);color:var(--muted);padding:4px 8px;border:1px solid var(--border);
    border-radius:6px;font-size:.7rem;opacity:.9;z-index:9999;display:none;}
    #saveBtn { display:block; margin:4px 0; padding:6px 10px; font-size:.85rem; cursor:pointer; }
  </style>
</head>

<body>
  <div id="cheat">üíæ Ctrl/Cmd+Enter to save ‚Ä¢ ‚ãØ for tools ‚Ä¢ Reflection to browse ‚Ä¢ ‚úèÔ∏è Edit ‚Ä¢ üóëÔ∏è Delete</div>

  <header>
    <h1>Quiet Journal</h1>
    <div>
      <button onclick="toggleDrawer()">‚ãØ</button>
      <button onclick="toggleMode()" id="modeBtn">Reflection</button>
    </div>
  </header>

  <textarea id="input" placeholder="Write‚Ä¶"></textarea>
  <button id="saveBtn">üíæ Save Entry (Ctrl/Cmd + Enter)</button>

  <div id="drawer">
    <button onclick="toggleDark()">Toggle dark mode</button>
    <select id="yearFilter" onchange="applyYearFilter()"><option value="all">All years</option></select>
    <button onclick="exportTxt()">Export TXT</button>
    <button onclick="exportMd()">Export Markdown</button>
    <button onclick="backup()">Backup</button>
    <button onclick="restore()">Restore</button>
    <button onclick="showReadme()">Read README</button>
  </div>

  <input type="file" id="restoreFile" hidden>
  <div id="journal"></div>

  <script>
    /* DRAWER */
    function toggleDrawer(){drawer.style.display = drawer.style.display==="block" ? "none" : "block";}

    /* DARK MODE */
    if(localStorage.getItem("dark")==="true") document.body.classList.add("dark");
    function toggleDark(){
      document.body.classList.toggle("dark");
      localStorage.setItem("dark",document.body.classList.contains("dark"));
    }

    /* REFLECTION MODE */
    let reflection=false;
    const saveBtn = document.getElementById("saveBtn");
    function toggleMode(){
      reflection=!reflection;
      modeBtn.textContent = reflection ? "Write" : "Reflection";
      input.readOnly = reflection;
      input.style.display = reflection ? "none" : "block";
      saveBtn.style.display = reflection ? "none" : "block";
      load(yearFilter.value);
    }

    /* AUTO-RESIZE */
    function autoResizeTextarea(textarea){
      textarea.style.height="auto";
      textarea.style.height = textarea.scrollHeight + "px";
    }

    /* CORE */
    const input=document.getElementById("input");
    const journalDiv=document.getElementById("journal");
    input.focus();
    input.addEventListener("input", ()=>autoResizeTextarea(input));
    autoResizeTextarea(input);

    document.addEventListener("keydown", e => {
      if (!reflection && (e.ctrlKey || e.metaKey) && e.key === "Enter") addEntry();
    });
    saveBtn.onclick = addEntry;

    function todayKey(d=new Date()){return d.toISOString().split("T")[0];}

    function addEntry(){
      const text=input.value.trim(); if(!text) return;
      const now=new Date(), key=todayKey();
      const data=JSON.parse(localStorage.getItem("journal")||"{}");
      data[key]=data[key]||[];
      data[key].unshift({time:now.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),text});
      localStorage.setItem("journal",JSON.stringify(data));
      populateYearFilter(); load();
      input.value=""; input.focus(); autoResizeTextarea(input);
    }

    /* LOAD ENTRIES */
    function load(year="all"){
      journalDiv.innerHTML="";
      const data=JSON.parse(localStorage.getItem("journal")||"{}");
      Object.keys(data).sort().reverse().forEach(date=>{
        if(year==="all"||date.startsWith(year)) renderDay(date,data[date]);
      });
      showOnThisDay();
    }

    function renderDay(date,entries){
      const d=new Date(date);
      const div=document.createElement("div"); div.className="day";
      div.innerHTML=`<div class="date ${date===todayKey()?"today":""}">
        ${date===todayKey()?"Today ‚Äî ":""}${d.toDateString()}</div>`;
      entries.forEach((e,i)=>{
        const entryDiv = document.createElement("div");
        entryDiv.className="entry";
        entryDiv.innerHTML=`<div class="time">${e.time}</div><div class="text">${e.text}</div>`;
        if(reflection){
          const btnContainer = document.createElement("div");
          btnContainer.className = "buttons";
          const editBtn=document.createElement("button"); editBtn.textContent="‚úèÔ∏è";
          editBtn.onclick=()=>editEntryInline(date,i,entryDiv);
          const delBtn=document.createElement("button"); delBtn.textContent="üóëÔ∏è";
          delBtn.onclick=()=>deleteEntry(date,i);
          btnContainer.appendChild(editBtn);
          btnContainer.appendChild(delBtn);
          entryDiv.appendChild(btnContainer);
        }
        div.appendChild(entryDiv);
      });
      journalDiv.appendChild(div);
    }

    /* INLINE EDIT ‚Äî FIXED FOR BIG TEXT */
    function editEntryInline(date,index,entryDiv){
      const data = JSON.parse(localStorage.getItem("journal") || "{}");
      const currentText = data[date][index].text;

      const textDiv = entryDiv.querySelector(".text");
      textDiv.style.display = "none"; // Hide the current entry text

      const existing = entryDiv.querySelector(".editContainer");
      if(existing) existing.remove();

      const editContainer = document.createElement("div");
      editContainer.className = "editContainer";
      editContainer.style.display = "flex";
      editContainer.style.flexDirection = "column";
      editContainer.style.gap = "4px";

      const textarea = document.createElement("textarea");
      textarea.value = currentText;
      textarea.style.width="100%";
      textarea.style.fontFamily = input.style.fontFamily;
      textarea.style.fontSize = input.style.fontSize;
      textarea.style.lineHeight = input.style.lineHeight;
      textarea.style.padding = input.style.padding;
      textarea.style.minHeight = "80px";
      textarea.style.resize = "none";
      textarea.style.overflowY = "hidden";

      function autoResize() {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      }
      textarea.addEventListener("input", autoResize);
      autoResize();

      const saveBtn = document.createElement("button");
      saveBtn.textContent="üíæ Save";
      saveBtn.style.alignSelf="flex-start";
      saveBtn.onclick = () => {
        data[date][index].text = textarea.value.trim();
        localStorage.setItem("journal", JSON.stringify(data));
        load(yearFilter.value);
      };

      editContainer.appendChild(textarea);
      editContainer.appendChild(saveBtn);
      entryDiv.appendChild(editContainer);
      textarea.focus();
    }

    /* DELETE */
    function deleteEntry(date,index){
      if(!confirm("Delete this entry?")) return;
      const data=JSON.parse(localStorage.getItem("journal")||"{}");
      data[date].splice(index,1);
      if(data[date].length===0) delete data[date];
      localStorage.setItem("journal",JSON.stringify(data));
      populateYearFilter(); load(yearFilter.value);
    }

    /* YEAR FILTER */
    function populateYearFilter(){
      const data=JSON.parse(localStorage.getItem("journal")||"{}");
      const years=[...new Set(Object.keys(data).map(d=>d.slice(0,4)))].sort().reverse();
      yearFilter.innerHTML='<option value="all">All years</option>';
      years.forEach(y=>yearFilter.innerHTML+=`<option>${y}</option>`);
    }
    function applyYearFilter(){ load(yearFilter.value); }

    /* ON THIS DAY */
    function showOnThisDay(){
      const data=JSON.parse(localStorage.getItem("journal")||"{}");
      const mmdd=todayKey().slice(5);
      const hits=Object.keys(data).filter(d=>d.endsWith(mmdd)&&!d.startsWith(new Date().getFullYear()));
      if(!hits.length) return;
      const box=document.createElement("div");
      box.className="on-this-day"; box.textContent="On this day:";
      hits.sort().reverse().forEach(d=>{
        data[d].forEach(e=>box.innerHTML+=`<div>${d.slice(0,4)} ‚Äî ${e.text}</div>`);
      });
      journalDiv.prepend(box);
    }

    /* EXPORT / BACKUP */
    function exportTxt(){ download(format("txt"),"journal.txt"); }
    function exportMd(){ download(format("md"),"journal.md"); }
    function format(type){
      const data=JSON.parse(localStorage.getItem("journal")||"{}"); let out="";
      Object.keys(data).sort().forEach(d=>{
        data[d].forEach(e=>{out+=type==="md"?`## ${d}\n- **${e.time}** ${e.text}\n\n`:`${d} ${e.time} - ${e.text}\n`;});
      }); return out;
    }
    function download(c,n){const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([c])); a.download=n; a.click();}
    function backup(){ download(localStorage.getItem("journal")||"{}","journal-backup.json"); }
    function restore(){ restoreFile.click(); }
    restoreFile.onchange=e=>{
      const r=new FileReader();
      r.onload=ev=>{ localStorage.setItem("journal",ev.target.result); populateYearFilter(); load(); };
      r.readAsText(e.target.files[0]);
    };

    /* READ README */
    function showReadme(){
      const readmeText = `
      Quiet Journal ‚Äî Quick Start (Compact & Aligned)

      A minimalist offline journal. Open, write, reflect, edit, delete, and export.

      Writing:
      - Type in the textarea.
      - Press Enter for line breaks ‚Äî they will appear in display.
      - Save: click üíæ Save Entry button or press Ctrl/Cmd + Enter.

      Reflection Mode:
      - Click Reflection to browse entries.
      - ‚úèÔ∏è Edit ‚Üí opens inline textarea for editing.
      - üóëÔ∏è Delete ‚Üí click to remove an entry (with confirmation).
      - Edit/Delete buttons are grouped together.

      Filters & View:
      - Year filter to see entries from a specific year.
      - Dark mode toggle available.
      - Compact layout aligns timestamps & text for easy reading.
      - Line breaks preserved.

      Backup & Export:
      - Backup: single JSON file.
      - Export: TXT / Markdown.

      On This Day:
      - Displays entries from previous years on the same day.

      PWA & Offline:
      - Install via browser ‚ÄúAdd to Home Screen‚Äù.
      - Works offline automatically.

      > No password ‚Äî open immediately.
      `;
      journalDiv.innerHTML = `<pre style="white-space:pre-wrap; font-family:inherit; padding:8px; background:rgba(0,0,0,0.02); border-radius:4px;">${readmeText}</pre>`;
    }

    /* CHEAT SHEET */
    if(!localStorage.getItem("seenCheat")){
      const cheat=document.getElementById("cheat");
      cheat.style.display="block";
      setTimeout(()=>{cheat.style.display="none"; localStorage.setItem("seenCheat","true");},5000);
    }

    /* SERVICE WORKER */
    if("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");

    populateYearFilter(); load();
  </script>
</body>
</html>
